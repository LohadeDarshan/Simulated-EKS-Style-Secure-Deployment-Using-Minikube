name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install yamllint
        run: pip install yamllint
      
      - name: Lint YAML files
        run: |
          find manifests/ -name "*.yaml" -o -name "*.yml" | xargs yamllint
      
      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck
      
      - name: Lint shell scripts
        run: |
          find scripts/ -name "*.sh" | xargs shellcheck

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Minikube
        uses: medyagh/setup-minikube@latest
        with:
          cpus: 2
          memory: 4096
      
      - name: Deploy applications
        run: |
          chmod +x scripts/setup/*.sh
          ./scripts/setup/complete-setup.sh
      
      - name: Run tests
        run: |
          chmod +x scripts/testing/*.sh
          ./scripts/testing/test-deployments.sh
